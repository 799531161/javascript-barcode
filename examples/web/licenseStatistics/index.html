<!DOCTYPE html>
<html>
<head>
    <title>License Statistics Sample</title>
    <meta charset="UTF-8">
</head>
<body>
<div id="div-video-container">
    <select class="dbrScanner-sel-camera"></select>
    <select class="dbrScanner-sel-resolution"></select>
    <br>
    <video class="dbrScanner-video" playsinline="true"></video>
</div>

<script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@7/dist/dbr.min.js" data-productKeys="PRODUCT-KEYS"></script>
<script>
    let scanner = null;
    // Use a uuid to mark a virtual device.
    // Each browser, which can't get uuid form localStorage,
    // in a physical device will be regarded as a new virtual device.
    let uuid = localStorage.getItem('dbr-uuid');
    if(!uuid){
        // Code from https://stackoverflow.com/a/2117523.
        // Do not change the way you generate the uuid.
        uuid = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => 
            (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
        localStorage.setItem('dbr-uuid', uuid);
    }
    let lastPostTime = -Infinity;
    let timeOut;
    let unsendBarcodeCounts = 0;

    (async ()=>{
        let info = await fetchData("/dbr-license-statistical/get-info");
        timeOut = info.timeOut;
        scanner = await Dynamsoft.BarcodeScanner.createInstance({
            onUnduplicatedRead: txt => {
                ++unsendBarcodeCounts;
                let now = Date.now();
                if(now - lastPostTime >= timeOut){
                    lastPostTime = now;
                    let record = { uuid: uuid, time: lastPostTime, counts: unsendBarcodeCounts };
                    fetchData("/dbr-license-statistical/post-record", pageRecord, "POST");
                    unsendBarcodeCounts = 0;
                }

                console.log(txt);
            },
            videoSettings: { video: { width: { ideal: 1280 }, height: {ideal: 720 }, facingMode: { ideal: 'environment' } } },
        });
        scanner.open();
    })();
    
    function fetchData(url = '', data = null, method = 'GET') {
        // Default options are marked with *
        return fetch(url, {
            method: method, // *GET, POST, PUT, DELETE, etc.
            mode: 'cors', // no-cors, cors, *same-origin
            cache: 'default', // *default, no-cache, reload, force-cache, only-if-cached
            credentials: 'same-origin', // include, *same-origin, omit
            headers: data ? {
                'Content-Type': 'application/json',
                // 'Content-Type': 'application/x-www-form-urlencoded',
            } : null,
            redirect: 'follow', // manual, *follow, error
            referrer: 'no-referrer', // no-referrer, *client
            body: data ? JSON.stringify(data) : null, // body data type must match "Content-Type" header
        })
        .then(response => {
            if(response.ok){
                return response.json() // parses JSON response into native JavaScript objects
            }else{
                throw 'HTTP ERROR: ' + response.statusText;
            }
        })
        .then((data) => {
            console.log("data:",data);
            return data;
        });
    }
</script>
</body>
</html>