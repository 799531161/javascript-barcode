<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>
<body>
    <p>Please read <a href="../../Documents/guide.md" target="_blank">guide.md</a> or <a href="https://www.dynamsoft.com/help/Barcode-Reader-WASM/" target="_blank">online-document</a> first if you haven't read it!</p>
    <p>The sample use a light version. Click <a href="decodeVideoInWorker_stable.html">this</a> to switch to a stable version.</p>
    <p>'UseDbrInWorker' does not perform well in mobile browser in our test.</p>
    <p>To enable video, please host the site in https!</p>
    <div id="divLoading">loading...</div>
    <div id="divReading" style="display:none">Reading...</div>
    <button id="btn-startReadVideo" disabled>start read</button>
    <button id="btn-stopReadVideo" style="display:none">stop read</button>
    <div id="divVideoContainer" style="max-width:90%;position:relative;">
        <video id="theVideo" style="width:100%;height:100%;" playsinline="true"></video>
        <div id="divVideoRegion" style="position:absolute;margin:auto;left:0;top:0;right:0;bottom:0;width:100%;height:100%;border:3px solid #50A8E1;"></div>
    </div>
    <script src="js/jquery-3.2.1.slim.min.js"></script>
    <!-- optional, a log tool -->
    <script src="js/kConsole.js"></script>
    <script>
        var useDbrInWorker = new Worker("js/decodeVideoInWorker.js");
        var dbrWorkerCallbackDic = {};

        // handle worker message
        useDbrInWorker.onmessage = function(e){
            e = e.data;
            switch(e.type){
                case "load":{
                    if(e.success){
                        playvideo();
                    }
                    break;
                }
                case "log": {
                    kConsoleLog(e.body);
                    if(typeof e.body == 'string' || e.body instanceof String){
                        $('#divLoading').html(e.body);
                    }
                    break;
                }
                case "task": {
                    try{
                        dbrWorkerCallbackDic[e.id](e.body);
                        dbrWorkerCallbackDic[e.id] = undefined;
                    }catch(ex){
                        dbrWorkerCallbackDic[e.id] = undefined;
                        throw ex;
                    }
                }
            }
        };

        var playvideo = ()=>{
            kConsoleLog('======before video========');
            navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 }, facingMode: { ideal: 'environment' } } }).then((stream)=>{
                kConsoleLog('======get video========');
                var video = $('#theVideo')[0];
                video.srcObject = stream;
                video.onloadedmetadata = ()=>{
                    kConsoleLog('======play video========');
                    video.play();
                    kConsoleLog('======played video========');

                    $('#btn-startReadVideo').removeAttr('disabled');
                };
            }).catch((ex)=>{
                kConsoleLog(ex);
            });
        };
        
        $('#btn-startReadVideo').click(()=>{
            $('#divReading').show();
            $('#btn-startReadVideo').hide();
            $('#btn-stopReadVideo').show();
            isLooping = true;
            $('#kConsoleShowHideBtn').click();
            loopReadVideo();
        });
        $('#btn-stopReadVideo').click(()=>{
            $('#btn-stopReadVideo').hide();
            $('#btn-startReadVideo').show();
            isLooping = false;
            $('#divReading').hide();
        });

        var isLooping = false;
        //worker can't send HTMLElement, so it's a little complex
        var loopReadVideo = function(){
            if(!isLooping){
                return;
            }
            kConsoleLog('======= once read =======')
            var timestart = (new Date()).getTime();

            var video = $('#theVideo')[0];
            var vw = video.videoWidth;
            var vh = video.videoHeight;
            
            //crop a video region for decode
            var cvs = document.createElement('canvas');
            cvs.width = vw;
            cvs.height = vh;
            var ctx = cvs.getContext('2d');
            ctx.drawImage(video,0,0);
            
            //convert to a worker available data format
            new Promise(resolve=>{
                if(ctx.getImageData){//Uint8ClampedArray
                    resolve(ctx.getImageData(0,0,cvs.width,cvs.height).data);
                }else{//base64
                    resolve(cvs.toDataURL());
                }
            }).then(source=>{
                var taskId = Math.random();

                //define callback
                dbrWorkerCallbackDic[taskId] = function(response){
                    if(response.success){
                        var results = response.results;
                        kConsoleLog('time cost: ' + ((new Date()).getTime() - timestart) + 'ms');
                        for(var i=0;i<results.length;++i){
                            var result = results[i];
                            kConsoleLog(result.BarcodeText);
                        }
                        // video in safair would stuck, so leave 2s for adjusting video 
                        setTimeout(loopReadVideo, 2000);
                    }else{
                        kConsoleError(response.message);
                        setTimeout(loopReadVideo, 2000);
                    }
                };

                //send to worker
                if(ctx.getImageData){//Uint8ClampedArray
                    useDbrInWorker.postMessage({type: "decodeBuffer", id: taskId, body: source, width: cvs.width, height: cvs.height});
                }else{//base64
                    useDbrInWorker.postMessage({type: "decodeBase64String", id: taskId, body: source});
                }
            });
        };
    </script>
</body>
</html>